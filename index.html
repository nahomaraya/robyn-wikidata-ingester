<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic StoryMapJS Example</title>

  <!-- StoryMapJS CSS + JS -->
  <link rel="stylesheet" href="https://cdn.knightlab.com/libs/storymapjs/latest/css/storymap.css">
  <script src="https://cdn.knightlab.com/libs/storymapjs/latest/js/storymap-min.js"></script>

  <style>
    body { margin: 0; padding: 0; }
    #storymap { width: 100%; height: 600px; } /* Required height */
  </style>
</head>
<body>
  <div id="storymap"></div>

  <script>
    // Your API endpoint
    const apiUrl = 'http://localhost:3000/collection/items';

    async function initStoryMap() {
      try {
        // Fetch the items from your API
        const response = await fetch(apiUrl);
        const items = await response.json();

        // Transform the API data into StoryMapJS slides
        const slides = items
        .filter(item => item.location) // skip if location is null
        .map(item => {
          return {
            text: {
              headline: item.name,
              text: item.desc || ''
            },
            location: {
              name: item.location.locationName || '',
              lat: parseFloat(item.location.latitude),
              lon: parseFloat(item.location.longitude),
              zoom: 6
            },
            media: item.image ? {
              url: item.image.original_url,
              caption: item.image.filename,
              credit: `Source: <a href="${item.image.commons_url}" target="_blank">Wikimedia Commons</a>`
            } : null // if image is null, StoryMapJS will ignore media
          };
        });


        // Optional overview slide
        slides.unshift({
          type: "overview",
          text: {
            headline: "Overview",
            text: "Map overview of all story points"
          },
          location: {
            lat: 20,
            lon: 0,
            zoom: 2
          }
        });

        // Full StoryMapJS JSON
        const storymapData = {
          width: 800,
          height: 600,
          storymap: {
            language: "en",
            map_type: "osm:standard",
            slides: slides
          }
        };

        // Initialize StoryMap
        const storymap = new KLStoryMap.StoryMap('storymap', storymapData, {});
        window.onresize = () => storymap.updateDisplay();

      } catch (error) {
        console.error("Error loading StoryMap:", error);
        document.getElementById('storymap').innerHTML = "<p>Failed to load map. Check console.</p>";
      }
    }

    // Run the initialization
    initStoryMap();
  </script>
</body>
</html>
