<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic StoryMapJS Example</title>

  <!-- StoryMapJS CSS + JS -->
  <link rel="stylesheet" href="https://cdn.knightlab.com/libs/storymapjs/latest/css/storymap.css">
  <script src="https://cdn.knightlab.com/libs/storymapjs/latest/js/storymap-min.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #storymap { 
      width: 100%; 
      height: 800px; 
      flex: 1;
    } /* Required height */
    
    footer {
      position: sticky;
      bottom: 0;
      z-index: 100;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading {
      animation: spin 1s linear infinite;
    }
    
    .loading #buttonText {
      display: none;
    }
    
    .loading #loadingSpinner {
      display: inline !important;
    }
  </style>
</head>
<body>
  <div style="padding:12px 16px;border-bottom:1px solid #e5e5e5;background:#fafafa;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;">
    <form id="filterForm" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label for="itemId" style="font-size:14px;color:#333;">Item ID</label>
        <input id="itemId" name="itemId" type="text" value="Q5167679" placeholder="e.g. Q5167679" 
               style="padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px;width:140px;">
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label for="propertyId" style="font-size:14px;color:#333;">Property ID</label>
        <input id="propertyId" name="propertyId" type="text" value="P828" placeholder="e.g. P828" 
               style="padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px;width:140px;">
      </div>
      <button type="submit" id="loadButton"
              style="background:#007cba;color:white;padding:10px 16px;border:none;border-radius:6px;font-size:14px;cursor:pointer;display:flex;align-items:center;gap:8px;">
        <span id="buttonText">Load</span>
        <span id="loadingSpinner" style="display:none;">⟳</span>
      </button>
      </form>
  </div>

  <div id="storymap"></div>

  <footer style="padding: 16px; text-align: center; background: #f8f9fa; border-top: 1px solid #e5e5e5; font-size: 12px; color: #666;">
    Made with ❤️ by <a href="https://meta.wikimedia.org/wiki/User:Khajitdadddy" target="_blank">Khajitdadddy</a>
  </footer>

  <script>
    // API endpoint base for filtering
    const filterApiBase = 'https://wikidata-timetrail.vercel.app/collection/multiitems';
    // API endpoint base for resolving labels
    const nameApiBase = 'https://wikidata-timetrail.vercel.app/wikidata/itemName/';

    async function fetchNameForId(id) {
      if (!id) return '';
      console.log('Fetching name for ID:', id);
      try {
        const url = nameApiBase + encodeURIComponent(id);
        console.log('Fetching from URL:', url);
        const res = await fetch(url);
        console.log('Response status:', res.status);
        if (!res.ok) {
          console.log('Response not ok:', res.status, res.statusText);
          return '';
        }
        // Try to get text first, then parse as JSON if needed
        const text = await res.text();
        console.log('Response text:', text);
        
        // Try to parse as JSON first
        try {
          const data = JSON.parse(text);
          if (typeof data === 'string') return data;
          if (data && typeof data.name === 'string') return data.name;
        } catch (jsonError) {
          // If JSON parsing fails, treat as plain text
          console.log('Not JSON, treating as plain text:', text);
          return text;
        }
        return '';
      } catch (error) {
        console.log('Error fetching name:', error);
        return '';
      }
    }

    // Helper function to check if a URL can be embedded in iframe
    async function canEmbedUrl(url) {
      try {
        // Create a test iframe to check if the URL can be embedded
        const testIframe = document.createElement('iframe');
        testIframe.style.display = 'none';
        testIframe.src = url;
        
        return new Promise((resolve) => {
          const timeout = setTimeout(() => {
            document.body.removeChild(testIframe);
            resolve(false); // Timeout - likely blocked
          }, 3000);
          
          testIframe.onload = () => {
            clearTimeout(timeout);
            document.body.removeChild(testIframe);
            resolve(true);
          };
          
          testIframe.onerror = () => {
            clearTimeout(timeout);
            document.body.removeChild(testIframe);
            resolve(false);
          };
          
          document.body.appendChild(testIframe);
        });
      } catch (error) {
        console.warn(`Error checking embeddability for ${url}:`, error);
        return false;
      }
    }

    async function createSlidesFromItems(items, selectedItemId, selectedPropertyId, selectedItemName, selectedPropertyName) {
      // Transform the API data into StoryMapJS slides
      const slides = await Promise.all(
        items
        .filter(item => {
          if (!item.location) return false;
          const lat = parseFloat(item.location.latitude);
          const lon = parseFloat(item.location.longitude);
          return !isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0;
        }) // skip if location is null or has invalid coordinates
        .map(async (item) => {
          let media = null;
          
          if (item.image) {
            media = {
              url: item.image.original_url,
              caption: item.image.filename,
              credit: `Source: <a href="${item.image.commons_url}" target="_blank">Wikimedia Commons</a>`
            };
          } else if (item.identifier) {
            // Check if the URL can be embedded before using it
            const canEmbed = await canEmbedUrl(item.identifier);
            if (canEmbed) {
              media = {
                url: item.identifier,
                caption: "External Content",
                credit: `Source: <a href="${item.identifier}" target="_blank">View External Content</a>`
              };
            } else {
              // Fallback: show a link instead of iframe
              console.warn(`Cannot embed ${item.identifier} - using fallback`);
              media = {
                url: `data:text/html,<div style="padding:20px;text-align:center;"><h3>External Content</h3><p>This content cannot be embedded.</p><a href="${item.identifier}" target="_blank" style="background:#007cba;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;">View External Content</a></div>`,
                caption: "External Content (Click to view)",
                credit: `Source: <a href="${item.identifier}" target="_blank">View External Content</a>`
              };
            }
          }

          return {
            text: {
              headline: item.name,
              text: `
                ${item.desc || ''} 
                <br><strong>Location:</strong> ${item.location.locationName || ''} 
                ${item.id ? `<br><a href="https://www.wikidata.org/wiki/${item.id}" target="_blank">View on Wikidata</a>` : ''}
              `
            },
            location: {
              name: item.location.locationName || '',
              lat: parseFloat(item.location.latitude) || 0,
              lon: parseFloat(item.location.longitude) || 0,
              zoom: 6
            },
            media: media
          };
        })
      );

      // Optional overview slide
      slides.unshift({
        type: "overview",
        text: {
          headline: "Wikidata TimeTrail — Visualize the history of any Wikidata item with StoryMapJS!",
          text: `Enter an Item ID and Property ID to trace your own timeline — and see where the data leads! Current selection shows:  ${(selectedItemId || selectedPropertyId) ? `<br><br><strong>Current selection:</strong> ${selectedItemId ? `Item <code>${selectedItemId}</code> with name ${selectedItemName ? ` (${selectedItemName})` : ''}` : ''}${(selectedItemId && selectedPropertyId) ? ' · ' : ''}${selectedPropertyId ? `Property <code>${selectedPropertyId}</code>${selectedPropertyName ? ` (${selectedPropertyName})` : ''}` : ''}` : ''}`
        },
        // location: {
        //   lat: 11,
        //   lon: 39,
        //   zoom: 8  // zooms closer in
        // }
      });

      return slides;
    }

    function setLoadingState(loading) {
      const button = document.getElementById('loadButton');
      const buttonText = document.getElementById('buttonText');
      const loadingSpinner = document.getElementById('loadingSpinner');
      
      if (loading) {
        button.classList.add('loading');
        button.disabled = true;
        button.style.cursor = 'not-allowed';
        button.style.opacity = '0.7';
      } else {
        button.classList.remove('loading');
        button.disabled = false;
        button.style.cursor = 'pointer';
        button.style.opacity = '1';
      }
    }

    async function initStoryMap() {
      setLoadingState(true);
      try {
        // Fetch filtered items from API
        const itemId = (document.getElementById('itemId')).value || '';
        const propertyId = (document.getElementById('propertyId')).value || '';
        const [itemName, propertyName] = await Promise.all([
          fetchNameForId(itemId),
          fetchNameForId(propertyId)
        ]);
        const url = `${filterApiBase}?itemId=${encodeURIComponent(itemId)}&propertyId=${encodeURIComponent(propertyId)}`;
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }
        const items = await response.json();

        const slides = await createSlidesFromItems(items, itemId, propertyId, itemName, propertyName);
        console.log('Generated slides:', slides); // Debug: log the generated slides

        if (slides.length === 0) {
          throw new Error('No valid items with location data found');
        }

        // Full StoryMapJS JSON
        const storymapData = {
          width: 1200,
          height: 800,
          storymap: {
            language: "en",
            map_type: "osm:standard",
            slides: slides
          },

        };

        // Initialize StoryMap (reset container to rebuild)
        const container = document.getElementById('storymap');
        container.innerHTML = '';
        const storymap = new KLStoryMap.StoryMap('storymap', storymapData, {});
        window.onresize = () => storymap.updateDisplay();

      } catch (error) {
        console.error("Error loading StoryMap:", error);
        document.getElementById('storymap').innerHTML = "<p>Failed to load map. Check console.</p>";
      } finally {
        setLoadingState(false);
      }
    }
    

    // Wire up filter form and load defaults
    document.getElementById('filterForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      initStoryMap();
    });

    // Initial load with defaults
    initStoryMap();
  </script>
</body>
</html>
